<script>
  console.log("üî• Bridge loaded");

  setInterval(() => {
    if (!window.Kodular || !window.Kodular.getWebViewString) return;

    const raw = window.Kodular.getWebViewString();

    // üîí HARD FILTER
    if (!raw || raw[0] !== "{") return;

    console.log("üì© JSON received:", raw);

    try {
      const data = JSON.parse(raw);

      if (data.type === "WRITE") {
        firebase.database().ref(data.path).push(data.value)
          .then(() => {
            console.log("‚úÖ Write OK");
            window.Kodular.setWebViewString("OK");
          })
          .catch(err => {
            console.error("‚ùå Firebase error", err);
            window.Kodular.setWebViewString("FB_ERROR");
          });
      }
    } catch (e) {
      console.error("‚ùå JSON Parse failed", e, raw);
      window.Kodular.setWebViewString("JSON_ERROR");
    }
  }, 500);
</script>
