<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Kodular Firebase Bridge</title>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

<style>
body { font-family: monospace; background:#111; color:#0f0; }
pre { white-space: pre-wrap; }
</style>
</head>

<body>
<pre id="log">üî• Waiting for Kodular‚Ä¶</pre>

<script>
function log(msg) {
  console.log(msg);
  document.getElementById("log").textContent += "\n" + msg;
}

/* Firebase */
firebase.initializeApp({
  apiKey: "AIzaSyCnLPWHexvnsGwC-f8WjeQOHOP5Rtvk6fE",
  authDomain: "wedi-db408.firebaseapp.com",
  databaseURL: "https://wedi-db408-default-rtdb.firebaseio.com",
  projectId: "wedi-db408",
  storageBucket: "wedi-db408.appspot.com",
  messagingSenderId: "597651418673",
  appId: "1:597651418673:web:2469e379b6207d87be6f10"
});

const db = firebase.database();
log("üî• Firebase ready");

/* ===============================
   KODULAR BRIDGE (CORRECT WAY)
================================ */
window.AppInventor = window.AppInventor || {};

window.AppInventor.onWebViewStringChange = function (raw) {
  try {
    if (!raw) return;

    raw = raw.trim();
    log("üì© Received ‚Üí " + raw);

    if (raw[0] !== "{") return;

    const data = JSON.parse(raw);

    /* WRITE */
    if (data.type === "WRITE") {
      db.ref(data.path).push(data.value)
        .then(() => {
          log("‚úÖ Write OK");
          window.AppInventor.setWebViewString("OK");
        })
        .catch(() => {
          log("‚ùå Write Error");
          window.AppInventor.setWebViewString("Error");
        });
    }

    /* LOGIN */
    if (data.type === "LOGIN") {
      const ref = db.ref("users").push({
        name: data.name,
        created: Date.now()
      });

      const uid = "UID:" + ref.key;
      log("üë§ Login OK " + uid);
      window.AppInventor.setWebViewString(uid);
    }

  } catch (e) {
    log("‚ùå JSON Error " + e.message);
    window.AppInventor.setWebViewString("JSON Error");
  }
};
</script>
</body>
</html>
