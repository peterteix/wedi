<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Kodular Firebase Bridge</title>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #fafafa;
      padding: 10px;
    }
    pre {
      background: #eee;
      padding: 10px;
      font-size: 12px;
      white-space: pre-wrap;
    }
  </style>
</head>

<body>
  <h3>Firebase Bridge Loaded</h3>
  <pre id="log">Waiting for Kodular‚Ä¶</pre>

<script>
  /* ---------- LOGGING ---------- */
  function log(msg) {
    console.log(msg);
    document.getElementById("log").textContent += "\n" + msg;
  }

  /* ---------- FIREBASE CONFIG ---------- */
  const firebaseConfig = {
    apiKey: "AIzaSyCnLPWHexvnsGwC-f8WjeQOHOP5Rtvk6fE",
    authDomain: "wedi-db408.firebaseapp.com",
    databaseURL: "https://wedi-db408-default-rtdb.firebaseio.com",
    projectId: "wedi-db408",
    storageBucket: "wedi-db408.appspot.com",
    messagingSenderId: "597651418673",
    appId: "1:597651418673:web:2469e379b6207d87be6f10"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  log("üî• Firebase initialized");

  /* ---------- PREVENT RE-PROCESSING ---------- */
  let lastProcessed = "";

  /* ---------- MAIN LOOP ---------- */
  setInterval(() => {
    try {
      // ‚úÖ If running in browser (not Kodular), stop safely
      if (!window.AppInventor || !window.AppInventor.getWebViewString) {
        return;
      }

      const raw = window.AppInventor.getWebViewString();

      // Ignore empty, repeated, or non-JSON
      if (!raw || raw === lastProcessed || raw[0] !== "{") {
        return;
      }

      lastProcessed = raw;
      log("üì© Received JSON:");
      log(raw);

      const data = JSON.parse(raw);

      /* ---------- HANDLE WRITE ---------- */
      if (data.type === "WRITE") {
        db.ref(data.path).push(data.value)
          .then(() => {
            log("‚úÖ Firebase write success");
            window.AppInventor.setWebViewString("OK");
          })
          .catch(err => {
            log("‚ùå Firebase write error: " + err.message);
            window.AppInventor.setWebViewString("Error");
          });
      } else {
        log("‚ö† Unknown request type");
        window.AppInventor.setWebViewString("Error");
      }

    } catch (e) {
      log("‚ùå JSON Parse error: " + e.message);
      if (window.AppInventor) {
        window.AppInventor.setWebViewString("JSON Error");
      }
    }
  }, 500);
</script>

</body>
</html>
