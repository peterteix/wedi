<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Firebase Bridge</title>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

<script>
  // =========================
  // FIREBASE CONFIG
  // =========================
  const firebaseConfig = {
    apiKey: "AIzaSyCnLPWHexvnsGwC-f8WjeQOHOP5Rtvk6fE",
    authDomain: "wedi-db408.firebaseapp.com",
    databaseURL: "https://wedi-db408-default-rtdb.firebaseio.com",
    projectId: "wedi-db408",
    storageBucket: "wedi-db408.firebasestorage.app",
    messagingSenderId: "715353731093",
    appId: "1:715353731093:web:00706f8cd8898585fc9e1c"
  };

  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const database = firebase.database();

  let currentUID = null;
  let firebaseReady = false;

  function send(msg){
    if(window.AppInventor){
      window.AppInventor.setWebViewString(msg);
    }
  }

  // =========================
  // AUTH STATE LISTENER
  // =========================
  auth.onAuthStateChanged(function(user) {
    if (user) {
      currentUID = user.uid;
      firebaseReady = true;
    } else {
      auth.signInAnonymously().catch(function(error) {
        send("ERROR:AUTH");
      });
    }
  });

  // =========================
  // MESSAGE CHECK LOOP
  // =========================
  function checkMessage(){
    if(window.AppInventor){
      var msg = window.AppInventor.getWebViewString();
      if(msg && msg !== ""){
        handleMessage(msg);
        window.AppInventor.setWebViewString("");
      }
    }
  }

  function handleMessage(msg){

    // -------------------------
    // LOGIN COMMAND
    // -------------------------
    if(msg.startsWith("LOGIN|")){

      if(!firebaseReady || !currentUID){
        send("ERROR:NOTREADY");
        return;
      }

      send("UID:" + currentUID);
    }

    // -------------------------
    // WRITE COMMENT COMMAND
    // -------------------------
    if(msg.startsWith("WRITE|")){

      if(!firebaseReady || !currentUID){
        send("ERROR:NOUID");
        return;
      }

      let parts = msg.split("|");
      let title = parts[1] || "";
      let message = parts[2] || "";

      database.ref("comments/" + currentUID).push({
        title: title,
        message: message,
        timestamp: Date.now()
      }).then(function() {
        send("OK");
      }).catch(function() {
        send("ERROR:WRITE");
      });
    }
  }

  // Run every 300ms
  setInterval(checkMessage, 300);

</script>
</head>
<body>
</body>
</html>
