<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Kodular Firebase Bridge</title>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

<style>
body { font-family: monospace; background:#111; color:#0f0; }
pre { white-space: pre-wrap; }
</style>
</head>

<body>
<h3>Firebase Bridge Loaded</h3>
<pre id="log">Waiting‚Ä¶</pre>

<script>
function log(m) {
  console.log(m);
  document.getElementById("log").textContent += "\n" + m;
}

const firebaseConfig = {
  apiKey: "AIzaSyCnLPWHexvnsGwC-f8WjeQOHOP5Rtvk6fE",
  authDomain: "wedi-db408.firebaseapp.com",
  databaseURL: "https://wedi-db408-default-rtdb.firebaseio.com",
  projectId: "wedi-db408",
  storageBucket: "wedi-db408.appspot.com",
  messagingSenderId: "597651418673",
  appId: "1:597651418673:web:2469e379b6207d87be6f10"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
log("üî• Firebase ready");

setInterval(() => {
  try {
    if (!window.AppInventor) return;

    let raw = window.AppInventor.getWebViewString();
    if (!raw) return;

    raw = raw.trim();

    // Ignore responses like OK / UID:
    if (raw[0] !== "{") return;

    // üî• HARD FIX: extract clean JSON only
    const start = raw.indexOf("{");
    const end   = raw.lastIndexOf("}");

    if (start === -1 || end === -1 || end <= start) return;

    const cleanJson = raw.substring(start, end + 1);

    log("üì© CLEAN JSON ‚Üí " + cleanJson);

    const data = JSON.parse(cleanJson);

    // Clear immediately
    window.AppInventor.setWebViewString("");

    if (data.type === "LOGIN") {
      const ref = db.ref("users").push({
        name: data.name,
        created: Date.now()
      });
      window.AppInventor.setWebViewString("UID:" + ref.key);
      log("üë§ Login OK");
    }

    else if (data.type === "WRITE") {
      db.ref(data.path).push(data.value)
        .then(() => {
          window.AppInventor.setWebViewString("OK");
          log("‚úÖ Write OK");
        })
        .catch(e => {
          window.AppInventor.setWebViewString("Error");
          log("‚ùå Firebase error");
        });
    }

  } catch (e) {
    log("‚ùå JSON PARSE FAILED ‚Üí " + e.message);
    window.AppInventor.setWebViewString("");
  }
}, 400);
</script>
</body>
</html>
